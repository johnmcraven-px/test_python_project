# Use Ubuntu 22.04 as the base image
FROM ubuntu:22.04

# Install dependencies, including OpenMPI
RUN apt-get update && apt-get install -y \
    wget \
    build-essential \
    cmake \
    git \
    ca-certificates \
    openmpi-bin \
    libopenmpi-dev \
    libglu1-mesa-dev \
    libxt-dev \
    qtbase5-dev \
    qtchooser \
    qt5-qmake \
    qtbase5-dev-tools \
    curl \
    python3 \
    python3-pip \
    sudo \
    flex \
    bison \
    libscotch-dev \
    libscotchmetis-dev \
    libptscotch-dev \
    && apt-get clean

# Set the working directory
WORKDIR /home/openfoam

# Download and build Zoltan from source with -fPIC enabled globally
RUN git clone https://github.com/sandialabs/Zoltan.git \
    && cd Zoltan \
    && wget -O config.guess 'http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=HEAD' \
    && wget -O config.sub 'http://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=HEAD' \
    && mkdir ../Zoltan-build \
    && cd ../Zoltan-build \
    && CFLAGS="-fPIC" CXXFLAGS="-fPIC" FCFLAGS="-fPIC" FFLAGS="-fPIC" ../Zoltan/configure --prefix=/usr/local --with-mpi=/usr --build=aarch64-unknown-linux-gnu \
    && make clean \
    && make -j $(nproc) \
    && make install

# Clone the OpenFOAM repository
RUN git clone https://github.com/OpenFOAM/OpenFOAM-dev.git

# Build OpenFOAM in /opt/OpenFOAM-dev
RUN mkdir -p /opt/OpenFOAM-dev \
    && mv /home/openfoam/OpenFOAM-dev /opt/OpenFOAM-dev \
    && /bin/bash -c "source /opt/OpenFOAM-dev/OpenFOAM-dev/etc/bashrc && cd /opt/OpenFOAM-dev/OpenFOAM-dev && ./Allwmake -j $(nproc)"

# Set up environment variables
RUN echo "source /opt/OpenFOAM-dev/OpenFOAM-dev/etc/bashrc" >> ~/.bashrc

# Copy the local directory to the container
COPY . /opt/OpenFOAM-dev/case

# Set the entrypoint to bash
ENTRYPOINT ["/bin/bash"]
